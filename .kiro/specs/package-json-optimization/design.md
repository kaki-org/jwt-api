# 設計書

## 概要

この設計は、front/package.json 設定における 3 つの重要な最適化領域に対処します：

1. 適切な依存関係管理を伴う完全な Vuetify セットアップ
2. モダンな Node.js 環境における不要な Node.js レガシーオプションの削除
3. 競合する pnpm ビルド依存関係設定の解決

このソリューションにより、よりクリーンで保守しやすく、適切に機能する開発環境が確保されます。

## アーキテクチャ

### 現状分析

現在の package.json にはいくつかの問題があります：

- Vuetify は依存関係に適切に含まれています（✓ 既に解決済み）
- `@nuxtjs/vuetify`は devDependencies にあり、nuxt.config.ts で設定されています
- すべての npm スクリプトが Node.js 20.12.2+では不要な`--openssl-legacy-provider`フラグを使用しています
- pnpm 設定で`esbuild`が`ignoredBuiltDependencies`と`onlyBuiltDependencies`の両方に含まれています

### 目標状態

1. **Vuetify 設定**: 両方のパッケージを使用した現在の動作するセットアップを維持
2. **Node.js スクリプト**: レガシー OpenSSL フラグを削除し、互換性をテスト
3. **pnpm 設定**: 競合するビルド依存関係ルールを解決

## コンポーネントとインターフェース

### 1. パッケージ依存関係管理

- **入力**: dependencies と devDependencies を含む現在の package.json
- **処理**: Vuetify セットアップが完全で機能的であることを検証
- **出力**: 動作が確認された Vuetify 設定

### 2. スクリプト最適化サービス

- **入力**: レガシー Node.js オプションを含む npm スクリプト
- **処理**:
  - すべてのスクリプトから`--openssl-legacy-provider`を削除
  - Node.js 20.12.2+との互換性について各スクリプトをテスト
  - レガシーオプションがまだ必要な場合はフォールバック文書を追加
- **出力**: クリーンでモダンな npm スクリプト

### 3. pnpm 設定リゾルバー

- **入力**: 競合する pnpm ビルド依存関係設定
- **処理**:
  - 実際にビルド処理が必要なパッケージを分析
  - 適切な戦略を選択して`esbuild`の競合を解決
  - 実際のニーズに基づいて他のビルド依存関係を最適化
- **出力**: 競合しない最適化された pnpm 設定

## データモデル

### パッケージ設定スキーマ

```typescript
interface PackageConfig {
  dependencies: Record<string, string>;
  devDependencies: Record<string, string>;
  scripts: Record<string, string>;
  pnpm: {
    ignoredBuiltDependencies?: string[];
    onlyBuiltDependencies?: string[];
  };
}
```

### スクリプト最適化ルール

```typescript
interface ScriptRule {
  pattern: RegExp;
  replacement: string;
  testCommand: string;
  fallbackRequired: boolean;
}
```

## エラーハンドリング

### スクリプト互換性の問題

- **検出**: 変更された各スクリプトをテストモードで実行
- **フォールバック**: レガシーオプションがまだ必要な場合は、具体的な理由を文書化
- **復旧**: 異なる Node.js バージョン用の条件付きスクリプトバリアントを提供

### ビルド依存関係の競合

- **検出**: pnpm 設定に競合するルールがないことを検証
- **解決**: 各パッケージに最も適切な戦略を選択
- **検証**: パッケージのインストールとビルドプロセスをテスト

### Vuetify 統合の問題

- **検出**: Vuetify コンポーネントがインポートおよび使用できることを確認
- **解決**: ランタイムとビルドタイムの両方の依存関係が満たされることを確保
- **テスト**: コンポーネントのレンダリングとスタイリングを検証

## テスト戦略

### ユニットテスト

- package.json の構文と構造を検証
- 個別のスクリプト実行をテスト
- pnpm 設定の解析を検証

### 統合テスト

- 完全な開発ワークフロー（`pnpm install` → `pnpm dev`）をテスト
- Vuetify コンポーネントが正しくレンダリングされることを確認
- 最適化された設定でビルドプロセスをテスト

### 互換性テスト

- レガシーフラグなしで Node.js 20.12.2+でスクリプトをテスト
- pnpm がビルド依存関係を正しく処理することを確認
- 既存機能に回帰がないことを確保

### ロールバック戦略

- 変更前に現在の package.json をバックアップ
- 各変更を段階的にテスト
- 問題が発生した場合の明確なロールバック手順を提供

## 実装アプローチ

1. **フェーズ 1**: Vuetify 検証

   - 現在の Vuetify セットアップが動作していることを確認
   - コンポーネントのインポートとレンダリングをテスト

2. **フェーズ 2**: スクリプトのモダン化

   - レガシー Node.js フラグを体系的に削除
   - 各スクリプトを個別にテスト
   - 残りの互換性要件を文書化

3. **フェーズ 3**: pnpm 設定の最適化

   - esbuild の競合を解決
   - 他のビルド依存関係ルールを最適化
   - インストールとビルドプロセスをテスト

4. **フェーズ 4**: 検証と文書化
   - 完全な開発ワークフローを実行
   - 変更と根拠を文書化
   - トラブルシューティングガイドを提供
